/** @jsxImportSource theme-ui */
import Head from 'next/head';

import { getClient } from '@lib/sanity.server';

import Header from '@components/header';
import CollectionPreview from '@components/collection-preview';
import QuickPost from '@components/quick-post';
import PostPreview from '@components/post-preview';

export default function Home({ data }) {
  const { posts } = data;

  // filter out posts that are already referenced somewhere else
  const unReferencedPosts = posts.filter((post) => {
    return (
      (post._type === 'post' && !post.referenced) ||
      post._type !== 'post'
    );
  });
  function renderContent({ _type, _id, ...rest }) {
    switch (_type) {
      case 'collection':
        return <CollectionPreview key={_id} {...rest} />;
      case 'quickPost':
        return <QuickPost key={_id} {...rest} />;
      case 'post':
        return <PostPreview key={_id} {...rest} />;
      default:
        return null;
    }
  }

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header
        toggleProgress={() => {
          setShowProgress((p) => !p);
        }}
      />
      <div sx={{ variant: 'fullGrid' }}>
        <main sx={{ variant: 'fullGrid.contentCol' }}>
          {unReferencedPosts && unReferencedPosts.map(renderContent)}
        </main>
        {/* <aside sx={{gridColumn: 'auto / span 5'}}>
          {tracker && <Tracker visible={showProgress} {...tracker} />}
        </aside> */}
      </div>

      <footer></footer>
    </div>
  );
}

export async function getStaticProps() {
  const allPostsQuery = `
    {
      "posts": *[_type in ["post", "collection", "quickPost"]] | order(_createdAt asc) {
        ...,
        _type == 'post' || _type == 'collection' => {
          "slug": slug.current,
        },
        _type == "quickPost" => {
          tags[]-> {
            ...,
            "slug": slug.current
          },
        },
        // flag posts that are already referenced in a collection so we can filter them out
        // on the front-end
        _type == 'post' => {
          "referenced": count(*[_type == "collection" && references(^._id)]) > 0
        },
        _type == 'collection' => {
          type-> {
            ...,
            "slug": slug.current
          },
            posts[]-> {
            ...,
            "slug": slug.current
          },
          "allPostsTags": posts[]->.tags[]-> {
            _id,
            title,
            "slug": slug.current,
          },
          "_lastUpdatedAt": posts[]-> | order(_updatedAt desc)[0]._updatedAt
        },
      }
    }
  `;
  const data = await getClient().fetch(allPostsQuery);
  return {
    props: {
      data,
    },
  };
}
